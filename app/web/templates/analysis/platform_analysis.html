{% extends "layouts/base.html" %}

{% block title %}{{ platform.title() }} Analysis{% endblock %}

{% block page_title %}{{ platform.title() }} Analysis{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('dashboard.home') }}">Home</a></li>
<li class="breadcrumb-item active">{{ platform.title() }} Analysis</li>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          {% if platform == 'amazon' %}
            <i class="bi bi-shop me-1"></i>
          {% elif platform == 'twitter' %}
            <i class="bi bi-twitter me-1"></i>
          {% elif platform == 'instagram' %}
            <i class="bi bi-instagram me-1"></i>
          {% elif platform == 'tiktok' %}
            <i class="bi bi-tiktok me-1"></i>
          {% endif %}
          {{ platform.title() }} Analysis History
        </h3>
        <div class="card-tools">
          <a href="{{ url_for('dashboard.new_analysis') }}" class="btn btn-primary btn-sm">
            <i class="bi bi-plus"></i> New Analysis
          </a>
        </div>
      </div>
      <div class="card-body">
        {% if analyses %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Target</th>
                  <th>Sentiment</th>
                  <th>Quality Score</th>
                  <th>Date Created</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for analysis in analyses %}
                  {% set sentiment_data = analysis.sentiment_scores | from_json %}
                  {% set sentiment = sentiment_data.sentiment_analysis.sentiment if sentiment_data.sentiment_analysis else 'neutral' %}
                  {% set comprehensive = sentiment_data.comprehensive_analysis if sentiment_data.comprehensive_analysis else {} %}
                  {% set quality = comprehensive.content_quality.quality_score * 100 if comprehensive.content_quality else 0 %}
                  <tr>
                    <td>
                      <strong>{{ analysis.target_identifier[:40] }}</strong>
                      {% if analysis.target_identifier|length > 40 %}...{% endif %}
                      <br>
                      <small class="text-muted">{{ analysis.analysis_type }}</small>
                    </td>
                    <td>
                      <span class="badge bg-{{ 'success' if sentiment == 'positive' else 'danger' if sentiment == 'negative' else 'warning' }}">
                        {{ sentiment.title() }}
                      </span>
                      {% if sentiment_data.sentiment_analysis and sentiment_data.sentiment_analysis.confidence %}
                        <br><small class="text-muted">{{ "%.0f"|format(sentiment_data.sentiment_analysis.confidence * 100) }}% confidence</small>
                      {% endif %}
                    </td>
                    <td>
                      <div class="progress" style="height: 20px;">
                        <div class="progress-bar bg-{{ 'success' if quality > 70 else 'warning' if quality > 40 else 'danger' }}" 
                             role="progressbar" style="width: {{ quality }}%" 
                             aria-valuenow="{{ quality }}" aria-valuemin="0" aria-valuemax="100">
                          {{ "%.0f"|format(quality) }}%
                        </div>
                      </div>
                    </td>
                    <td>
                      {{ analysis.date_created.strftime('%Y-%m-%d') }}<br>
                      <small class="text-muted">{{ analysis.date_created.strftime('%H:%M') }}</small>
                    </td>
                    <td>
                      <span class="badge bg-{{ 'success' if analysis.status == 'completed' else 'warning' if analysis.status == 'pending' else 'danger' }}">
                        {{ analysis.status.title() }}
                      </span>
                    </td>
                    <td>
                      <div class="btn-group" role="group">
                        <a href="{{ url_for('dashboard.view_analysis', analysis_id=analysis.id) }}" 
                           class="btn btn-sm btn-outline-primary" title="View Details">
                          <i class="bi bi-eye"></i>
                        </a>
                        <form method="POST" action="{{ url_for('dashboard.delete_analysis', analysis_id=analysis.id) }}" 
                              class="d-inline" onsubmit="return confirm('Are you sure you want to delete this analysis?')">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                          <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          <!-- Pagination would go here -->
          {% if analyses|length >= 10 %}
            <div class="d-flex justify-content-center mt-3">
              <nav aria-label="Analysis pagination">
                <ul class="pagination">
                  <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                  </li>
                  <li class="page-item active">
                    <span class="page-link">1</span>
                  </li>
                  <li class="page-item disabled">
                    <span class="page-link">Next</span>
                  </li>
                </ul>
              </nav>
            </div>
          {% endif %}
          
        {% else %}
          <div class="text-center py-5">
            {% if platform == 'amazon' %}
              <i class="bi bi-shop" style="font-size: 4rem; color: #dee2e6;"></i>
            {% elif platform == 'twitter' %}
              <i class="bi bi-twitter" style="font-size: 4rem; color: #dee2e6;"></i>
            {% elif platform == 'instagram' %}
              <i class="bi bi-instagram" style="font-size: 4rem; color: #dee2e6;"></i>
            {% elif platform == 'tiktok' %}
              <i class="bi bi-tiktok" style="font-size: 4rem; color: #dee2e6;"></i>
            {% endif %}
            <h4 class="mt-3 text-muted">No {{ platform.title() }} analyses yet</h4>
            <p class="text-muted">Start analyzing {{ platform }} content to see insights here</p>
            <a href="{{ url_for('dashboard.new_analysis') }}" class="btn btn-primary">
              <i class="bi bi-plus-circle"></i> Create First Analysis
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Quick Stats Row -->
{% if analyses %}
<div class="row mt-3">
  <div class="col-md-3">
    <div class="info-box">
      <span class="info-box-icon bg-info"><i class="bi bi-bar-chart"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Total Analyses</span>
        <span class="info-box-number">{{ analyses|length }}</span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box">
      <span class="info-box-icon bg-success"><i class="bi bi-emoji-smile"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Positive Sentiment</span>
        <span class="info-box-number">
          {% set positive_count = analyses | selectattr('sentiment_scores') | map('from_json') | selectattr('sentiment_analysis.sentiment', 'equalto', 'positive') | list | length %}
          {{ positive_count }}
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box">
      <span class="info-box-icon bg-warning"><i class="bi bi-emoji-neutral"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Neutral Sentiment</span>
        <span class="info-box-number">
          {% set neutral_count = analyses | selectattr('sentiment_scores') | map('from_json') | selectattr('sentiment_analysis.sentiment', 'equalto', 'neutral') | list | length %}
          {{ neutral_count }}
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box">
      <span class="info-box-icon bg-danger"><i class="bi bi-emoji-frown"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Negative Sentiment</span>
        <span class="info-box-number">
          {% set negative_count = analyses | selectattr('sentiment_scores') | map('from_json') | selectattr('sentiment_analysis.sentiment', 'equalto', 'negative') | list | length %}
          {{ negative_count }}
        </span>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block additional_js %}
<script>
  // Auto-refresh every 30 seconds if there are pending analyses
  const hasPendingAnalyses = {{ (analyses | selectattr('status', 'equalto', 'pending') | list | length > 0) | tojson }};
  
  if (hasPendingAnalyses) {
    setTimeout(() => {
      location.reload();
    }, 30000);
  }
</script>
{% endblock %}
